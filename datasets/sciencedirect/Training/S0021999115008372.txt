@&#MAIN-TITLE@&#
Mesh adaptation on the sphere using optimal transport and the numerical solution of a Monge–Ampère type equation

@&#HIGHLIGHTS@&#
Numerical solution of the Monge–Ampère equation on the surface of a sphere.Optimal transport for mesh adaptation.New linearisation of the Monge–Ampère equation and exponential maps.Proof of existence of solutions.Comparisons with centroidal Voronoi tessellations on the sphere.

@&#KEYPHRASES@&#
Optimal transport,Adaptive,Mesh,Refinement,Mesh generation,Monge–Ampére,Atmosphere,Modelling,

@&#ABSTRACT@&#
An equation of Monge–Ampère type has, for the first time, been solved numerically on the surface of the sphere in order to generate optimally transported (OT) meshes, equidistributed with respect to a monitor function. Optimal transport generates meshes that keep the same connectivity as the original mesh, making them suitable for r-adaptive simulations, in which the equations of motion can be solved in a moving frame of reference in order to avoid mapping the solution between old and new meshes and to avoid load balancing problems on parallel computers.The semi-implicit solution of the Monge–Ampère type equation involves a new linearisation of the Hessian term, and exponential maps are used to map from old to new meshes on the sphere. The determinant of the Hessian is evaluated as the change in volume between old and new mesh cells, rather than using numerical approximations to the gradients.OT meshes are generated to compare with centroidal Voronoi tessellations on the sphere and are found to have advantages and disadvantages; OT equidistribution is more accurate, the number of iterations to convergence is independent of the mesh size, face skewness is reduced and the connectivity does not change. However anisotropy is higher and the OT meshes are non-orthogonal.It is shown that optimal transport on the sphere leads to meshes that do not tangle. However, tangling can be introduced by numerical errors in calculating the gradient of the mesh potential. Methods for alleviating this problem are explored.Finally, OT meshes are generated using observed precipitation as a monitor function, in order to demonstrate the potential power of the technique.

@&#INTRODUCTION@&#
The need to represent scale interactions in weather and climate prediction models has, for many decades, motivated research into the use of adaptive meshes [3,34,38]. R-adaptivity – mesh redistribution – involves deforming a mesh in order to vary local resolution and was first considered for atmospheric modelling more than twenty years ago by Dietachmayer and Droegemeier [14]. It is an attractive form of adaptivity since it does not involve altering the mesh connectivity, does not create load balancing problems because points are never created or destroyed, does not require mapping of solutions between meshes [26], does not lead to sudden changes in resolution and can be retro-fitted into existing models. Variational methods exist which attempt to control resolution in different directions for r-adaptive meshes (e.g. [23,25]). Alternatively, the solution of the Monge–Ampère equation to generate an optimally transported (OT) mesh based on a scalar valued monitor function is a useful form of r-adaptive mesh generation because it generates a mesh equidistributed with respect to a monitor function and does not lead to mesh tangling [7]. We will see that the optimal transport problem on the sphere leads to a slightly different equation of Monge–Ampère type, which has not before been solved numerically on the surface of a sphere, which would be necessary for weather and climate prediction using r-adaptivity.At first glance, r-adaptivity does not look ideal for adaptive meshing of the global atmosphere; Dietachmayer and Droegemeier [14] pointed out that the resulting meshes can be quite distorted which leads to truncation errors and it is not always possible to control the resolution in individual directions, just the total cell size (area or volume); with r-adaptivity, it is not possible, for example, to increase the total number of points around the equator, just re-distribute them [17]. However, if the mesh redistribution starts from a mesh with enough points around the equator, then these points can be redistributed according to transient features of the flow.Models of the global atmosphere are being developed with accurate treatment of non-orthogonality and which allow arbitrary grid structures [21,29,11,28,39]. The time may therefore be right to reconsider r-adaptive modelling of the global atmosphere.A powerful form of adaptivity that, like r-adaptivity, retains the same total number of points, is centroidal Voronoi tessellation using a non-uniform density (or monitor) function to control the mesh spacing, using Lloyd's algorithm [32]. Lloyd's algorithm generates smoothly varying, orthogonal, near centroidal isotropic meshes suitable for finite-volume models and is being used by the Model for Prediction Across Scales (MPAS, [35]). Lloyd's algorithm alters the mesh connectivity meaning that, if it is used in conjunction with dynamic mesh adaptivity, mapping between old and new solutions is needed and there is an additional layer of complexity involved with changing the data structures and moving information between parallel processors. Also, Lloyd's algorithm is extremely expensive, using an explicit solution to find an equidistributed mesh – an elliptic problem. The cost per iteration is proportional to the number of points, N, [24] and, in one dimension, the number of iterations is proportional to N[15]. Therefore, overall, the cost is proportional toN2. Conversely, generating optimally transported meshes using a semi-implicit technique, has convergence independent of the mesh size and the overall cost is proportional toNlog⁡N[5]. We therefore propose r-adaptivity which uses cheaper mesh generation and fixed data structures associated with the mesh.In section 2 we describe mesh generation by optimal transport in Euclidean space leading to a Monge–Ampère equation. We then show how these concepts can extend to mesh generation on the sphere, leading to an equation of Monge–Ampère type. Existing numerical solution techniques in Euclidean geometry are reviewed in section 3. In section 4 we describe the new numerical methods for solving the Monge–Ampère type equations, both on a Euclidean plane and on the sphere. In order to address issues of mesh distortion, a range of diagnostics of mesh quality are presented. These diagnostics, along with the diagnostics of solution convergence, are described in section 5 and the diagnostics of the meshes generated are presented in section 6. The meshes generated, both on the plane and on the sphere, are shown and described in section 6 and the meshes on the sphere are compared with centroidal Voronoi meshes generated using Lloyd's algorithm [32] with the same monitor function. In order to demonstrate the performance of the mesh generation using real data as a monitor function, meshes are generated using a monitor function derived from reanalysis precipitation in section 6. Final conclusions and recommendations for future work are drawn in section 7.A mesh is equidistributed with respect to a monitor function when the product of the cell volumes and the monitor function in the cell is constant across all mesh cells. The equidistribution principle alone does not lead to a well-defined problem for mesh generation. Indeed this problem is ill-posed in more than 1 dimension and so requires the imposition of an extra constraint. Budd and Williams [6] introduced optimal transport for mesh generation to find a map from the original mesh (or computational space,Ωc) to the new mesh (or physical space,Ωp). This technique was further developed by Budd et al. [7] and extended to 3 spatial dimensions by Browne et al. [5]. The optimal transport constraint says that the new mesh should be as close as possible to the original mesh – we seek to minimise the distance between the two meshes in a certain measure which we shall discuss. We write this minimization problem:(1)minx∈Ωp⁡d(ξ,x)2where d is the distance metric between the two meshes andξ∈Ωcmaps tox∈Ωp. In Cartesian space[0,1]nthis metric can simply be the sum of the Euclidean distance between all of the corresponding points defining the meshes. Brenier's theorem [4] then tells us that the unique, optimal transport map from x toξis the gradient of a convex scalar potential, ϕ, so that the new mesh locations are given by:(2)x=ξ+∇ϕ.The change in cell volume under the coordinate transform is given by the determinant of the Jacobian of the map,|J(ξ)|=|∇x(ξ)|, the gradient of x with respect toξ. Therefore, for equidistribution with respect to a monitor function, m, the new mesh locations should satisfy(3)|∇x|m(x)=cwhere c is a constant, uniform over space, which will be determined once the numerical method is defined. Taking the determinant of the gradient of eqn. (2), we can see that|∇x|=|I+∇∇ϕ|=|I+H(ϕ)|where I is the identity tensor and H is the Hessian. Consequently, for the mesh to be optimally transported and equidistributed, the mesh potential, ϕ, must satisfy a Monge–Ampère equation:(4)|I+H(ϕ)|m(x)=c.The presence of the identity tensor in this Monge–Ampère equation will be exploited in the linearisation to create a novel numerical algorithm.Mesh tangling is caused by a local loss of invertibility of the Jacobian of the map from the original to the transported mesh. Given that the solution of the Monge–Ampère equation, ϕ, is convex, the determinant of the Hessian of ϕ is positive and hence the Jacobian determinant of the map is positive and thus is invertible and the mesh will not tangle [7].A naive approach to r-adaptivity on the sphere,S2, would be to map the surface onto the plane, use an established method to solve a mesh redistribution problem on the plane, then map back to the sphere. As shown in Fig. 1, the desired map T could be written as a composition of mappings asT=g−1∘t∘g.A mapg:S2→R2must be chosen and an optimal transport map t found. The boundary conditions for the problem of finding t must be specified, and those boundary conditions would necessarily depend on g. For example in the case where the mapping g is simply the lat-lon decomposition ofS2, the boundary conditions for the mesh redistribution problem on the plane will then be periodic in the zonal direction. In the meridional direction, Neumann boundary conditions would not be appropriate as the poles will not be free to move and they will be mapped back to their original location underg−1.The Hairy Ball Theorem tells us that there must be at least one fixed point of the mapT:S2→S2. The decompositionT=g−1∘t∘gwould then be possible if g maps the fixed points of T to a Neumann boundary ofR2. However the location of the fixed points of T are not known a priori, and hence choosing g appropriately would form a significant problem by itself. Hence we will seek a direct optimal transport map,T:S2→S2which will be described in this section.On the surface of the sphere, we would still like to define an optimally transported mesh satisfying equidistribution:(5)r(ϕ)m(x)=cwherer=Vξ/Vxis the ratio of the volumes of the original mesh cells,Vξ, with vertices at positionsξ, and the volumes of the new mesh cells,Vx, with vertices at positionsx. We need to ascertain if unique solutions of (5) exist which minimise the distance between the original and resulting meshes. On the sphereS2, the appropriate distance metric is the Riemannian distance on the surface of the sphere between all of the corresponding points defining the meshes. We cannot use Brenier's theorem on the sphere. Instead, we appeal to the generalised version of Brenier's theorem given by McCann [27], a detailed discussion of which is given in Villani [37].Definition 1c-convex functionThe c-transformϕcof a functionϕ:S2→Ris defined as(6)ϕc(y)=supξ∈S2⁡{−c(ξ,x)−ϕ(ξ)}.The function ϕ is said to be c-convex, or cost-convex, if(ϕc)c=ϕ.Theorem 1(A combination of Theorems 8 and 9 of[27].) Let M be a connected, complete smooth Riemannian manifold, equipped with its standard volume measuredx. Letμ,νbe two probability measures on M with compact support, and let the objective functionc(ξ,x)be equal tod(ξ,x)2, where d is the geodesic distance on M. Further, assume that μ is absolutely continuous with respect to the volume measure on M. Then, the Monge–Kantorovich mass transportation problem between μ and ν admits a unique optimal transported map T where T pushes forward the measure μ onto ν. Then, (using classical optimal transport notation):(7)T#μ=νsuch that(8)x=T(ξ)=expξ⁡[∇ϕ(ξ)]for somed2/2-convex potential ϕ.Corollary 1There exists a unique, optimally transported mesh on the sphere that satisfies the equidistribution principle. Moreover, that mesh is defined by a c-convex scalar potential function that satisfies the Monge–Ampère type equation(9)m(expξ⁡[∇ϕ(ξ)])|J(ξ)|=c.ProofClearlyM=S2satisfies the conditions on M in Theorem 1. The first probability measure of interest, μ, we define to be the scaled Lebesgue measure such that:(10)dμ=dx∫S2dx.The target probability measure, μ, is the Lebesgue measure appropriately scaled by the monitor function to be equidistributed, such that:(11)dν=m(x)dx∫S2m(x)dx.AsM=S2these are trivially compactly supported. μ is absolutely continuous. Hence by Theorem 1 we have that there exists a unique solution, T, to the mass transportation problem between μ and ν. From (8) we can see that any point in the new mesh, x, is defined by the action of the exponential map on the scalar potential, ϕ.To see that this map, T, will give a mesh that satisfies the equidistribution principle, consider a cellAξin the original computational mesh,ΩCwith volumeVξ. The mapping of the cell under T gives the new cell,Axin the physical meshΩp. As T is a (optimal) transport map, then the integral over a set with respect to the measure μ equals the integral over the image of that set with respect to ν. Hence:(12)∫Aξdμ=∫Axdν⇒Vξ∫S2dx=∫Axm(x)dx∫S2m(x)dx.The ratio of the integral of the monitor function over the new cell with the total integral of the monitor function is equal to the proportion of the volume that the original cell occupied in the original mesh. This is precisely what it means for the monitor function to be equidistributed on a discretised mesh.Using a change of variables, we have:(13)Vξ∫S2dx=∫Axm(x)dx∫S2m(x)dx=∫Aξm(expξ⁡[∇ϕ(ξ)])|J(ξ)|dξ∫S2m(x)dxwhere|J(ξ)|is the determinant of the Jacobian of the mapT(ξ)=expξ⁡[∇ϕ(ξ)].As (13) must hold for arbitrary setsAξ∈ΩC, the following equation of Monge–Ampère type on the sphere results:(14)m(expξ⁡[∇ϕ(ξ)])|J(ξ)|=∫S2m(x)dx∫S2dx=c.□Corollary 2The optimally transported mesh on the sphere satisfying the equidistribution principle does not exhibit tangling.The choice of cost function c to be the squared geodesic distance is crucial to the proof of uniqueness in Theorem 1. Indeed simply taking c to be the square of the Euclidean distance is not sufficient [1]. The squared geodesic distance is necessary to ensure that the classical twist condition holds, i.e. T given in (7) is injective and hence is a map.The injectivity of this map ensures that (8) is locally invertible, i.e. for each point in the new mesh, x, there is a unique point in the original mesh,ξ, which maps to it – i.e. mesh tangling is not present.  □The fully non-linear, second-order, elliptic Monge–Ampère equation is:(15)|H(ϕ(ξ))|=f(ξ,ϕ)for independent variableξ∈ΩandΩ⊂Rdwhere ϕ is the (scalar) dependent variable, f is a known scalar function ofξand ϕ,H=∇∇is the Hessian (the tensorial gradient of the gradient) and|H|is the determinant of the Hessian. Froese and Oberman [19] give an excellent review of some numerical methods for solving this equation and this review draws from and adds to their review.There are two challenging parts to solving the Monge–Ampère equation. Firstly we need spatial discretisation methods both for the Hessian, H, and for the source term, f (although f is a known function, it can be a function of ϕ or of ∇ϕ, so numerical approximations are necessary). The spatial discretisation leads to a set of non-linear algebraic equations. Secondly, the algebraic equations require a numerical algorithm to find solutions. The discretisation should ensure that the solutions is convex based on a discrete definition of convexity. We will start by considering the spatial discretisation of the Hessian, H.Budd et al. [7] used finite differences on a structured, Cartesian grid to discretise the Hessian, a technique that was extended to three dimensions by Browne et al. [5]. Convexity was ensured by filtering the monitor function and smoothing the non-converged solution. Oberman [30] describe a finite difference method that uses a wide stencil to calculate the Hessian on a structured Cartesian grid. This was extended to three dimensions by Froese and Oberman [19]. The wide stencil was needed to ensure monotonicity of the iterative solution to the convex, numerical solution. Froese et al. [20] study the slightly different, 2-Hessian equation and describe how they rotate the coordinate system so that the Hessian is diagonal and hence the solution is convex and the discretisation is monotone. Feng and Neilan [16] approximate the Monge–Ampère equation by a fourth-order quasi-linear equation in order to use mixed finite elements for the spatial discretisation. Dean and Glowinski [12,13] also use mixed finite-elements on triangulations of the unit plane. All of these techniques have been used on either 2D or 3D Euclidean geometry.When solving the Monge–Ampère equation for mesh adaptation, the RHS of eqn (15) depends on ∇ϕ. Froese [18] pointed out that standard centred differences are not monotone for discretising this term and so used wide stencil finite differences. Saumier et al. [33] experimented with second and fourth order centred finite differences and a spectral method for discretising ∇ϕ.Once the Monge–Ampère equation is discretised in space, it is necessary to solve the resulting non-linear algebraic equations, the part of the method that we describe as the “algorithm”. Budd and Williams [6], Budd et al. [7] introduced a parabolic version of the Monge–Ampère equation which is solved by time-stepping, including an implicit relaxation term to smooth the transient solution and to speed up convergence:(16)(I−γ∇2)∂ϕ∂t=(m(∇ϕ)|I+H(ϕ)|)1dwhere γ is a scalar parameter defining the amount of smoothing applied,∇2is the Laplacian operator and d is the number of spatial dimensions. The time-stepping effectively creates fixed-point iterations but it may be possible to create more convergent iterations, without smoothing towards a uniform mesh. Benamou et al. [2] also used fixed-point iterations by linearising the two-dimensional Hessian term with a Laplacian:(17)|H(ϕ)|=12(∇2ϕ)2−ϕxx2+ϕyy22−ϕxy2.After some manipulation, this results in a Poisson equation which can be solved implicitly with the non-linear terms on the right hand side. Froese and Oberman [19] describe this as a semi-implicit method and use it to find the starting point for a Newton method. A Newton method is a common algorithm for solving the algebraic equations [12,19,10]. However the cost and complexity of the Newton method may not be necessary for mesh generation. In this paper we focus on fixed-point iterations, although the new linearisation proposed may also be beneficial for calculating the first guess for a Newton method.Equations of Monge–Ampère type have not before been solved numerically on the sphere. The description of the optimally transported mesh problem using the Monge–Ampère equation relies on properties of Euclidean geometry [7]. The numerical solution technique for the optimal transport problem on the surface of a sphere will be described in section 4.There are two aspects to solving equations of Monge–Ampère type in order to calculate optimally transported (OT) meshes. The spatial discretisation describes how to calculate the gradient and the Hessian of the mesh potential, ϕ, from discrete values (in this instance in finite volume cells). This will convert the PDE into a set of non-linear algebraic equations. The algorithm describes how to linearise and solve the large set of non-linear algebraic equations.A fixed-point iteration sequence to solve eqn. (4) can be found by observing that the linear terms of|I+H(ϕ)|are in fact1+∇2ϕwhere∇2is the Laplacian operator (linearising aboutϕ=0). Eqn. (4) can then be written as fixed-point iterations:(18)1+∇2ϕn+1=1+∇2ϕn−|I+H(ϕn)|+cnm(xn)where n is the iteration number and where:(19)xn=ξ+∇ϕn.This is simpler than the fixed-point iterations used by Feng and Neilan [16], Benamou et al. [2] because of the presence of the identity tensor in our Monge–Ampère equation which simplifies the linearisation. These fixed-point iterations are similar to the solution of the parabolic Monge–Ampère equation by Browne et al. [5] but could have advantages because the Laplacian term should initially accelerate convergence whereas the Laplacian smoothing used by Browne et al. [5] was only used to smooth intermediate iterations.Given suitable spatial discretisations, eqn. (18) can be solved forϕn+1given known valuesϕn. Assuming periodic boundary conditions, for the Poisson equation (18) to have a solution,cnmust take the value(20)cn=∑|I+H(ϕn)|Vξ∑Vξm(xn)whereVξare the volumes of the original, computational mesh cells and the summations are over all cells of the computational mesh.Without a monotone spatial discretisation, numerical solutions of the Monge–Ampère equation can become non-convex leading to artificial oscillations in the numerical solution and non-convergence [20]. The spatial discretisation described here is not monotone and the numerical solution can become non-convex. Therefore, in order to improve stability of the fixed-point iteration sequence, the Laplacian terms of eqn. (18) can be multiplied by a factor,1+α, whereα≥0:(21)(1+α)∇2ϕn+1=(1+α)∇2ϕn−|I+H(ϕn)|+cnm(xn)which clearly has no affect on a converged solution but will alter the convergence of the fixed-point iterations used to find ϕ and can help to keep the numerical solution smooth. This is a form of under-relaxation and the value of α will be defined in section 4.3.1. A solution of the Monge–Ampère equation only controls|I+H(ϕ)|, not the individual eigenvalues ofI+H(ϕ). If one of the eigenvalues gets large and the other small, the Laplacian preconditioning will not lead to convergent iterations without the under-relaxation.In order to solve the optimal transport problem on the sphere, we solve eqn (5) directly rather than eqn (4). However, in order to define fixed-point iterations, we need to find a linearisation of eqn. (5). For small maps, we assume that maps lie on a tangent to the sphere and so eqn. (5) can be approximated by eqn. (4). We then use the same linearisation as in section 4.1.1 and the same fixed-point iteration sequence:(22)(1+α)∇ϕn+1=(1+α)∇2ϕn−r(ϕn)+cnm(xn)where(23)xn=expξ⁡[∇ϕn(ξ)].No further approximation is needed forr=Vξn/Vxnsince the old and new cell volumes can be computed explicitly at every iteration. The linearisation will now be less accurate than in the Euclidean case due to the curvature of the sphere, so it may be necessary to increase α further to avoid divergence.We have found by experience, trial and error and by analogy with numerical solution techniques for the rotating shallow-water equations (e.g. [36]), some desirable properties of the spatial discretisation in order to achieve convergence. Further work to improve the spatial discretisation and prove convergence is needed.1.The discretisation of|I+H(ϕn)|should be consistent with the discretisation of1+∇2ϕotherwise the linearisation will not be close and the iterative solution will not converge quickly. In this context, consistent means that the trace of the discretisedH(ϕ)must be equal to∇2ϕ, as occurs analytically. This is only possible when solving eqn (21), not eqn. (22) since the relationship between r and1+∇2ϕis not known numerically.The spatial discretisation should be at least second-order accurate and the errors should be smooth. If we have rough truncation errors or first-order accurate truncation errors then truncation errors could lead to mesh tangling.To avoid grid-scale oscillations in the solution of ϕ, the spatial discretisation should be as compact as possible so that grid-scale oscillations of ϕ are not hidden in the discretisations of|I+H(ϕn)|andm(x).If the solution, ϕ, is convex or locally convex, then convex cells in the initial mesh should remain convex in the mapped mesh. This implies that ∇ϕ should have bounded variation.11We postulate that, following the TRiSK discretisation on polygons [36], the divergence of the mesh map on the initial (primal) mesh should be a convex combination of the divergence of the mesh map if it were calculated on a dual mesh (e.g. a triangulation).For cell i with facesf∈i, the simplest, most compact discretisation of the Laplacian, suitable for an orthogonal grid, using Gauss's divergence theorem, is:(24)∇i2ϕ≈1Vi∑f∈i∇nfϕ|Sf|where cell i has volumeVi,Sfis the outward pointing normal vector to cell i at face f with area equal to the face area so that|Sf|is the face area and gradient normal to each face is:(25)∇nfϕ=ϕif−ϕi|df|where cellifis the cell on the other side of face f from cell i and|df|is the (geodesic) distance between cell centre i andifin the computational domain. This simple form ensures curl free pressure gradients (assuming that the curl is calculated using Stokes circulation theorem around every edge of the 3D mesh). If cell i has centreξithendf=ξi−ξifin Euclidean geometry. On the surface of the sphere,|df|is the great circle distance betweenξiandξif. Locationsξiandξif, vectorSfanddffor cells i andifare shown in Fig. 2(a).Two approaches are taken to calculate the Hessian. The first we define a finite-difference approach (which uses both finite volume and finite difference approximations). The second uses the fact that, in solving the Monge–Ampère equation for mesh generation, we are approximating the change in cell volume by the determinant of the Hessian. Therefore, rather than calculating a discretised Hessian, we can simply use the change in cell volume, r. This is the geometric approach. The geometric approach is always used on the surface of the sphere.For a discretisation of the Hessian consistent with the discretisation of the Laplacian, we use Gauss's theorem:(26)H(ϕ)i=∇∇iϕ=1Vi∑f∈i∇fϕSfwhere∇fϕis the vector gradient of ϕ located at face f of cell i. The vector gradient,∇fϕ, is reconstructed from normal components,∇nfϕusing a least-squares fit which is derived by assuming that ∇ϕ is uniform so that it is first-order accurate on non-uniform meshes. This approach starts by reconstructing a cell-centred gradient from surrounding normal gradients using a least squares fit:(27)∇iϕ=(∑f∈iSˆfSfT)−1∑f∈i∇nfϕSf.whereSˆf=Sf/|Sf|. Next, a temporary value of the vector valued gradient at each face is calculated:(28)∇f′ϕ=λf∇iϕ+(1−λf)∇ifϕwhereλfis the coefficient for linear interpolation. For consistency with the Laplacian, we must have∇fϕ⋅Sf=∇nfϕ|Sf|which can be enforced with an explicit correction:(29)∇fϕ=∇f′ϕ+(∇nfϕ−∇f′ϕ⋅Sˆf)Sˆf.The Hessian calculated using eqn. (26) is not symmetric, as the analytic version would be.A numerical approximation for calculating H will introduce truncation errors so instead we can simply use the change in cell volume:(30)ri=|I+Hi(ϕ)|=Vi(x)Vi(ξ)whereVi(x)is the volume of the transported mesh cell i andVi(ξ)is the volume of the original cell. Volumes are calculated on the surface of the sphere by decomposing every polyhedron (on the original and new meshes) into tetrahedra with curved surfaces which are flat in spherical geometry. The volumes of these tetrahedra are found using the formula for the area of a spherical triangle.In order to calculate the mesh map and consequently to calculate m, we must calculate ∇ϕ at the mesh vertices,∇vϕ. (This is in contrast to [18,33] who discretise the gradient of ϕ at the same locations where ϕ is stored.) Ideally, the calculation of∇vϕshould not produce any non-convex cells and it turns out to be particularly sensitive to the numerical approximation and its stencil. In section 4.2.3.1 we will describe a large stencil gradient, for which grid-scale oscillations in ϕ can grow which are not seen in∇vϕand convergence is slow. In section 4.2.3.2 we will describe a small stencil gradient which can lead to grid-scale oscillations of∇vϕon a hexagonal mesh since the calculation of the gradient does not lead to a gradient with bounded variation. This leads to locally distorted meshes. Section 4.2.3.3 describes a compromise; a new Goldilocks stencil that combines the advantages of both large and small.In order to calculate∇vϕat the vertices,∇fϕat the faces is calculated using eqn. (29). These values are then interpolated onto the vertices using linear interpolation. On a mesh of squares, four values of∇fϕare averaged to calculate each∇vϕat a vertex and on a mesh of hexagons, three values of∇fϕare averaged to calculate each∇vϕ. Including the calculation of∇fϕ, the reconstruction of∇vϕfrom ϕ uses a stencil of 10 hexagons on a hexagonal mesh and 12 squares on a mesh of squares. Due to these large stencils, the gradients calculated are smooth even if the ϕ field is not smooth. Due to the averaging (interpolation) of the gradient from the cell centres to the vertices there will be some consistency between gradients at different vertices and so cells may remain convex.The vector gradient at each vertex,∇vϕ, can be reconstructed directly from the normal component of the gradient at the surrounding faces using a least squares fit(31)∇vϕ=(∑f∈vdfdfT)−1∑f∈v(df∇nfϕ)wheref∈vis the set of faces which share vertex v. This approximation is exact for a uniform vector field, ∇ϕ, and is consequently first order accurate on an arbitrary mesh. However on a hexagonal mesh, eqn. (31) only uses information from three surrounding faces and three surrounding hexagons and the resulting gradients are prone to grid-scale oscillations which can lead to the creation of non-convex cells. The small amount of information used at every vertex means that neighbouring vertices can have very different gradients. We therefore need a larger stencil, but not as large as the stencil used in section 4.2.3.1.On a mesh of squares, ϕ at four squares is sufficient to reconstruct a smooth∇vϕto second order.The Goldilocks stencil should be large enough to calculate a smooth gradient (with bounded variation) but without including averaging which can hide grid-scale oscillations in ϕ. The stencil used includes the faces which share vertex v and the face neighbours attached by a vertex to those faces (Fig. 3). The vertex gradient is then reconstructed using a least squares fit:(32)∇vϕ=(∑f∈v′∈f′∈vdfdfT)−1∑f∈v′∈f′∈v(df∇nfϕ)wheref∈v′∈f′∈vis the set of faces shown in Fig. 3. In the least squares fit in eqn. (32), the central faces are counted three times (making the fit more accurate near the centre, following Weller et al. [40]).Exponential maps are used to move vertices on the surface of the sphere. The direction of the map is given by the direction of∇vϕat vertex v (i.e. the direction is along the great circle in the plane of∇vϕ). The distance moved is the geodesic distance|∇vϕ|so that the vertex is rotated around the sphere by an angle|∇vϕ|/awhere a is the radius of the sphere.Spatial discretisation of eqns (21), (22) leads to a set of linear algebraic equations, which can be written as a matrix equation,Aϕ(n+1)=b(n), whereϕ(n+1)is the vector of all of the values of the unknown,ϕ(n+1). This matrix equation is solved using the OpenFOAM GAMG solver (geometric algebraic multi-grid, [31]) using diagonal incomplete Cholesky smoothing with 50 cells in the coarsest level. The residual for the solver tolerance is defined as:(33)∑|b−Aϕ|∑(|b|+|Aϕ|)where the sum is over all cells of the mesh (i.e. over all elements of the vectors b andAϕ). For each fixed-point iteration, the values of ϕ from the previous iteration are used as an initial guess for the solution of the matrix equation, so the initial residual should converge to the final residual as the fixed-point iterations converge. At each fixed point iteration (i.e. each value of n in eqn. (21)) the matrix equation is solved with a tolerance equal to the maximum of 0.001 times the initial residual and10−8. The matrix equation is not solved all the way to10−8at every fixed-point iteration to save computational cost but, when the fixed-point iterations have converged, the initial residual will be less than10−8. A weaker tolerance is probably acceptable for mesh generation but we are using a tight tolerance to have more confidence that the numerical method is convergent.If the initial mesh is Voronoi and it is required that the transported mesh is also Voronoi, then the Voronoi generating points can be moved using eqn. (2) using the cell centre gradient, reconstructed from the face gradient using volume weighting. Then the moved generating points can be re-tessellated to create a new Voronoi tessellation. However, the re-tessellation may not have exactly the same connectivity due to edge swapping in the Delaunay algorithm. This technique therefore may not be so suitable for r-adaptivity.When using r-adaptivity, the mesh monitor function (that controls the mesh density) will need to be mapped from the previous mesh onto the new transported mesh so that it can be evaluated when solving eqns. (21) or (22). In section 6, we first present results using an analytic monitor function, which is evaluated at the transported mesh cell centres. We then use observed meteorological data to calculate a monitor function by mapping the data to the computational grid and then apply Laplacian smoothing, as described in section 4.3.2.Here we describe how α is calculated. We start by defining the source terms of the eqns (21), (22) to besn=|I+H(ϕn)|−c/m(xn)andsn=r(ϕn)−c/m(xn)respectively. For convergence to occur, we would like the source term to decrease relative to the Laplacian term,∇2ϕ. Initially, the source term has order 1. In the tests undertaken, both on the plane and on a sphere, it has been sufficient to keep the ratio of the Laplacian to the source term greater than four and to always ensure that α increases with iteration number, n. So α is set to be:(34)1+αn+1=max⁡(1+αn,4max⁡(1/4,max⁡(|sn|)))Following Browne et al. [5], we experimented with smoothing the monitor function and this smoothing certainly improved convergence and generated meshes with smoother grading and hence lower anisotropy and skewness and better orthogonality (see section 5). However the purpose of this work is to describe a robust solution of the Monge–Ampère equation on the sphere for any monitor function. So smoothing of the monitor function will not be considered for the analytically defined monitor functions. However, when using meteorological data to define a monitor function, the monitor function is smoothed on the computational grid during each iteration using Laplacian smoothing:m=m′(expξ⁡∇ϕ)+14∇⋅(|df|2∇m′(expξ⁡∇ϕ))wherem′is the monitor function mapped from the meteorological data onto the physical grid at positionexpξ⁡∇ϕand m is the monitor function used in the source terms of eqns. (21), (22). The diffusion coefficient used is the square of the mesh spacing,|df|on the computational grid.Convergence is measured in two ways. Firstly, convergence is measured by plotting the initial residual (eqn 33) of the matrix equation at every fixed point iteration as a function of iteration number. This gives an indication of how much the solution is changing for each fixed-point iteration.Secondly, the convergence of the final solution is assessed by plotting the change in cell area between the initial mesh and the final iteration for every cell in comparison toc/m. At convergence, these should be equal. The test cases considered use an axi-symmetric monitor function, m, so this measure is plotted as a scatter plot against distance to the axis of symmetry. This tells us where the solution is not converging to the required monitor function and also, for solutions using|I+H(ϕn)|instead ofr(ϕn)(i.e. using the finite difference Hessian rather than the geometric Hessian) in the Monge–Ampère equation, it tells us how well|I+H(ϕn)|approximatesr(ϕn).The diagnostics of mesh quality consider cell centres, defined as cell centroids or centres of mass of the moved cells, and face centres, defined in the same way. These will also use the face area vector,Sx, the normal vector to each face with magnitude equal to the face area anddx, the vector between cell centres either side of a face of the deformed mesh (see Fig. 2(b)).In order to measure mesh quality, firstly we will consider mesh spacing,|dx|, between adjacent cell centres for each cell face as a scatter diagram as a function of distance to the axis of symmetry (for the axi-symmetric cases). This informs us about the aspect ratios of the cells since cells with high aspect ratio will give a large scatter of values of|dx|for a given distance to the axis of symmetry. If the mesh is perfectly equidistributed then cell areas should be given byc/m. Therefore, for the meshes of quadrilaterals,|dx|will be compared withc/mand for the meshes of mostly hexagons,|dx|will be compared with2ctan⁡(π/3)/3m.The second mesh quality diagnostic is non-orthogonality for each cell face which is measured as(35)non-orthogonality=cos−1⁡Sx⋅dx|Sx||dx|.The third mesh quality diagnostic is the face skewness, measured as the distance,ds, between the face centre and the crossing point between the vectordxwith the face, normalised by|dx|:(36)skewness=ds|dx|.The skewness distance,ds, is shown as a short grey line in Fig. 2(b). This definition of skewness is a feature of the non-linearities of the map generating the mesh and is different quantitatively and qualitatively from that of Budd et al. [8] which can be calculated directly the Jacobian of the map. The skewness metric, Q, from Budd et al. [8] gives information about isotropy and orthogonality, not face skewness.

@&#CONCLUSIONS@&#
A technique for generating optimally transported (OT) meshes, solving a Monge–Ampère type equation on the surface of the sphere, has been developed in order to generate meshes which are equidistributed with respect to a monitor function. Equations of Monge–Ampère type have not before been solved numerically on the surface of a sphere. We show that a unique solution to the optimal mesh transport problem on the sphere exists and exponential maps are used to create the map from the old to the new mesh. We introduce a geometric interpretation of the Hessian rather than a numerical approximation which is accurate on the surface of the sphere. In order to create a semi-implicit algorithm, a new linearisation of the Monge–Ampère equation is proposed which includes a Laplacian term and the resulting Poisson equation is solved at each fixed-point iteration.To validate the novel aspects of the numerical method, we first reproduce some known solutions of the Monge–Ampère equation on a two dimensional plane and find that the geometric interpretation of the Hessian leads to more accurate equidistribution than a finite difference discretisation. We also generate OT meshes of polygons on the sphere to compare with the centroidal Voronoi meshes generated by Ringler et al. [32]. The geometric Hessian accurately equidistributed meshes on the surface of the sphere. The algorithm is found to be sensitive to the numerical method used to calculate the gradient of the mesh potential (the map to the new mesh) with a compact stencil leading to non-convexity and a large stencil leading to very slow convergence. The mesh tangling can be eliminated by creating a Voronoi tessellation of the cell centres of the final mesh. The exact solution of the OT problem on the sphere is c-convex which means that the mesh should not tangle. A numerical method which reproduces this property will be the subject of future work.The meshes generated have advantages and disadvantages relative to centroidal Voronoi meshes generated using Lloyd's algorithm. In principle, OT meshes should be much faster to generate, although we do not yet have timing comparisons. OT meshes do not change their connectivity with respect to the base, uniform mesh, so these meshes can be used in r-adaptive simulations. In comparison to centroidal Voronoi meshes, the OT meshes are non-orthogonal and less isotropic but have less face skewness. In order to overcome the non-orthogonality of OT meshes, the OT technique can be used to generate Voronoi meshes.Finally, we generate a mesh using a monitor function based on reanalysis precipitation. This mesh refines smoothly along atmospheric fronts and convergence zones and provides inspiration for using r-adaptivity for global atmospheric modelling. Suitable monitor functions for r-adaptive simulations is also the subject of future work.