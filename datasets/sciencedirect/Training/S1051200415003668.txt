@&#MAIN-TITLE@&#
Retinex theory based active contour model for segmentation of inhomogeneous images

@&#HIGHLIGHTS@&#
We propose a global convex segmentation model for images with inhomogeneity.We incorporate the Retinex theory into the active contour model.The segmentating procedure is led by the image intensity and the light reflection.We give the fast and easy Split-Bregman method for the proposed model.Experiments demonstrate the outstanding performance for texture segmentation.

@&#KEYPHRASES@&#
Image segmentation,Intensity inhomogeneity,Split-Bregman algorithm,Active contour model,Retinex theory,

@&#ABSTRACT@&#
Intensity inhomogeneity in images makes automated segmentation of these images difficult. As intensity inhomogeneity is often caused by inhomogeneous light reflection, the Retinex theory can be used to reduce inhomogeneity. We introduce the Retinex theory into the active contour model, which is commonly used for image segmentation. The segmentation procedure is then guided by the image intensity and light reflection. In order to solve the proposed model efficiently, we develop a new fast Split Bregman algorithm. Experimental results on a variety of real images with inhomogeneity validate the performance of the proposed methods.

@&#INTRODUCTION@&#
Image segmentation is a fundamental task in image processing, whose goal is to separate an image into distinct regions of similar characteristics. Active contour models are popular methods for image segmentation. Existing active contour models can be categorized into parametric and region based models. Parametric models [1,2] often use image gradients to guide the contour evolution towards object boundaries. These models often fail when gradients are not strong near object edges. Based on the Mumford–Shah model [20], Chan and Vese [3] proposed a model which used the mean values of different regions to guide contour evolution. This model is more robust than gradients based methods and other active contours using statistical information such as variance, moments or other image features [4–9]. However, these image statistics are inadequate to describe inhomogeneous images. To handle image inhomogeneity, Li et al. [10] proposed an efficient level set method for segmenting inhomogeneous images that minimizes a local binary fitting (LBF) energy function. They proposed a local intensity clustering [11] method and a local clustering criterion function [12], which was applied to MRI segmentation [13] as well as bias correction. Zhang et al. [14] proposed a new region-based active contour model. They introduced the local image fitting (LIF) energy to extract the local image information. Gaussian filtering based method was also proposed for regularizing the level set function which can eliminate the need of re-initialization. Wang et al. [15] proposed a local Chan–Vese (LCV) model for inhomogeneous image segmentation. The model is based on a local statistical function and the level set method and consists of global term, local term and regularization term respectively. Inhomogeneous images can also be efficiently segmented by incorporating local image information into the proposed model. Sun et al. [16] proposed a robust active contour model using local morphology fitting for automatic vascular segmentation from 2-D angiogram images. They used a linear structuring element with adaptive scale and orientation to fit the vessels. Wang et al. [17] defined a weighted least squares energy function for a linear classifier in each local region. The local energy functions are integrated into the convex piece-wise constant level set segmentation model, which achieved accurate segmentation results. Lauze et al. [36] formulated the bias segmentation as optimizing a “background disocclusion” criterion. The optimization leads to a coupled contour evolution equation, an inpainting equation, and a linear PDE which depends on inpainting. Wang et al. [18] used Gaussian distribution fitting function for different means and variances for different areas. They defined a local energy, named the local Gaussian distribution fitting (LGDF), to characterize the local data around a neighborhood of points. He et al. [19] proposed an improved region-scalable fitting (RSF) model [12] by mollifying Gaussian kernel in [10]. The RSF energy is redefined by a weighted-sum energy, where the weight is deduced by local entropy from grey level distributions of the image.The above methods used local fitting energy to approximate the pixel values in the inhomogeneous image and the pixel values are deemed as constant in a small neighborhood. They do not take into account the nature of inhomogeneous images. They are also local minimization models which means the segmentation results depend on the initial position of the active contour model. Different initial curve positions may lead to different segmentation results. To deal with this problem, Bresson et al. [21] and Chan et al. [22] proposed a global minimization segmentation model by modifying the original CV (Chan–Vese) model to a convex CV model. The modified model is global convex, that is, the segmentation results are not related to the initial position of the curve.In this paper, we apply the well-known Retinex theory to inhomogeneous image segmentation. We incorporate the Retinex theory into the active contour model and add the illumination term to its energy function so that the contour is evolved to the right position guided by the illumination and reflection terms. An alternative minimization algorithm is used to solve the energy function. To simplify the implementation and accelerate the energy function minimization, the Split Bregman [23] method is introduced, which is originally used for total variation (TV) norm [21] and which was proven faster than the dual method and equivalent to the augmented Lagrangian method [24,25].Our contribution includes a new segmentation model which incorporates the Retinex theory to region based active contour model for segmenting inhomogeneous images. The novelty of the proposed model is that it simultaneously performs image enhancement and segmentation, rather than one after the other. The active contour evolution is guided by the estimated illumination and reflection. Our contribution also include a new fast Split-Bregman method for solving the proposed model.The paper is organized as follows: section 2 reviews image enhancement based on the Retinex theory. Section 3 describes a new active contour model which integrates Retinex theory for image enhancement, as well as the design of the fast Split-Bregman method for implementing the active contour model. Section 4 tests the proposed method on inhomogeneous images, and section 5 concludes the paper.The Human Visual System (HSV) is able to recognize and match the same color under a wide range of illuminations, this is the so called “Color Constancy Phenomenon”. An explanation for this perceptual phenomenon was proposed by E. Land [26–29] through the Retinex theory. However colorful camera images are illumination dependent and the Retinex provides a way to operationalize this color constancy phenomenon by decomposing the formation of an image S as a product of an illumination factor (L) and a reflection (R), as shown in Eq. (1):(1)S=L⋅R,where we assume0<R<1and0<L<∞. In the logarithmic domain,s=log⁡(S),l=log⁡(L),r=log⁡(R), so thats=l+r.The essence of the so-called Retinex problem is to recover illumination from image. Once illumination is recovered and removed from the image leaving only the reflectance, the image will no longer have intensity inhomogeneity. Variational methods have been used for solving this Retinex problem. Kimmel et al. [30] first proposed a variational model for Retinex. They assumed that illumination varies smoothly in the image and the reflectance image has a high prior probability. Based on all the assumptions they defined a penalty functional and cast the Retinex problem as a variational minimization problem. Ma et al. [31] developed a TV Bregman iterative model for Retinex theory, simplifying the implementation of the Retinex theory for image enhancement. Ng et al. [32] also proposed a TV minimization model for Retinex for image enhancement. They took into account the constraints of the reflection function, which made his model more powerful. They propose to minimize the following energy:(2)minr,l⁡{E(r,l)=∫Ω|∇l|2+α2(s−l−r)2+β|∇r|+μ2l2dx}Subject to:r≤0andl≥s,where α, β, μ are the parameters which control the balance of every energy term. As the parameters increase, more penalty will be imposed on the relevant energy term. The illumination of the image is constrained by|∇l|2as it varies smoothly. The second term implicitly supposes that the error obeys Gaussian distribution. The third term is the constraint of the reflection which can ensure edge preservation. The last term is used only for the theoretical setting [32]. By using Eq. (2), the image can be decomposed into illumination and reflection terms. Fig. 1illustrates image enhancement with the Retinex theory. In next section, we incorporate the Retinex theory into the active contour model for segmentation of inhomogeneous images.In this section, we first give a brief introduction of the classical Chan–Vese model, followed by the proposed Retinex based segmentation model. We then present the detailed implementation of the proposed model by using split Bregman algorithm.The Chan–Vese active contour model [21] is defined as(3)argminϕ∈{0,1}{E(ϕ,c1,c2)=α∫Ω(u−c1)2ϕdxdy+β∫Ω(u−c2)2(1−ϕ)dxdy+γ∫Ω|∇ϕ|dxdy},wherec1andc2are the mean values of the inside and outside of the contour ϕ; α, β, γ are the parameters, and u is the image to be segmented.c1andc2are updated by Eq. (4):(4)C1=∫Ωuϕdxdy∫Ωϕdxdy,C2=∫Ωu(1−ϕ)dxdy∫Ω(1−ϕ)dxdy.In the new model, we relax the condition of ϕ from{0,1}to[0,1]. Thus the proposed model will be less sensitive to initialization.{0,1}means that ϕ can only be set as 0 or 1.[0,1]means the value ϕ can be selected from 0 to 1. When the energy reaches the minimum, the contour can reach the boundary of the areas. However, the method still fails on inhomogeneous images. The reason is that the mean values of the inside and outside of the curve are disturbed by the inhomogeneous light.To segment inhomogeneous images, we add illumination to the active contour model. Because the Retinex theory based image enhancement model decomposes the image into illumination and reflection, we incorporate the model (Eq. (2)) into the active contour model. The proposed model is thus:(5)argminϕ∈[0,1]{E(ϕ,r1,l1,r2,l2)=λ∫Ω|∇ϕ|dxdy+∫Ω(12(s−r1−l1)2+α12|∇l1|2+β1|∇r1|+μ12l12)ϕdxdy+∫Ω(12(s−r2−l2)2+α22|∇l2|2+β2|∇r2|+μ22l22)(1−ϕ)dxdy},where ϕ is the active contour,l1andl2are the illumination in different areas,r1,r2are the reflections of the objects, andα1,α2,β1,β2,μ1,μ2, λ are the parameters. The model can also be considered as the active contour model whose curve evolution is guided by the gradients of objects and illumination. So the proposed model is suitable for segmentation of inhomogeneous images. The proposed model is an improved model of piecewise-smoothing Mumford–Shah model [34]. The piecewise smooth Mumford–Shah model is modified using the Retinex theory, by changing the term(u−f)2+|∇u|2to|∇l|2+α2(s−l−r)2+β|∇r|+μ2l2. This modification allows our model to deal with bias segmentation using the gradient and local/global bias fields information which can be obtained using Retinex theory.We use the alternating minimization method to solve the five variables in the model. Eq. (5) can be divided into the following three sub-problems:Fixingr2,l1,l2and ϕ, the energy function with respect to the variabler1is:(6)minr1⁡{E(r1)=∫Ω(12(s−r1−l1)2+α12|∇l1|2+β1|∇r1|+μ12l12)ϕdxdy}.Fixingr1,l1,l2and ϕ, the energy function with respect to the variabler2is:(7)minr2⁡{E(r2)=∫Ω(12(s−r2−l2)2+α12|∇l2|2+β2|∇r2|+μ22l22)(1−ϕ)dxdy}.Fixingr1,r2,l1,l2, the energy function with respect to the variable ϕ is:(8)argminϕ∈[0,1]{E(ϕ)=λ∫Ω|∇ϕ|dxdy+∫ΩR(u1,u2)ϕdxdy}where(9)R(u1,u2)=(12(s−r1−l1)2+α12|∇l1|2+β1|∇r1|+μ12l12)−(12(s−r2−l2)2+α12|∇l2|2+β2|∇r2|+μ22l22).In order to solver1, we use the Split Bregman method by introducing auxiliary vector variablew→and Bregman iterative parameterb→1and transform original model (6) into the following equivalent minimization problem [24]. It is worth to mention here that Split Bregman is identical to augmented Lagrangian [25], which is also known as alternating direction method of multipliers (ADMM). It has been widely applied for L1 regularization problems:(10)(r1k+1,w→1k+1)=argminr1,w→1{E(r1,w→1)=∫Ω(12(s−r1−l1)2+α12|∇l1|2+β1|w→1|)ϕdx+∫Ωθ12|w→1−∇r1−b→1k+1|2ϕdx+∫Ωμ12l12ϕdx}whereθ1is the parameter. The update function of Bregman parameter isb→1k+1=b→1k+∇r1k−w→1k. The initialization isb→10=w→10=0. Eq. (10) is also solved by alternating minimization method. The energy function with respect to the variabler1is(11)E(r1)=∫Ω12(s−r1−l1)2ϕdx+∫Ωθ12|w→1−∇r1−b→1k+1|2ϕdx.The Euler–Lagrange equation and the boundary condition of Eq. (12) is:(12){r1+l1−s+θ1∇⋅(w→1−∇r1−b→1k+1)=0inΩ(w→1−∇r1−b→1k+1)⋅n→=0on∂Ωwheren→is the outer normal vector field to ∂Ω, the boundary of region Ω. Discretizing Eq. (12), we get the update equation ofr1. For convenience, we set the space step as 1 in all the discrete setting(13)r1(i,j)=1(1+4θ1)(s(i,j)−l1(i,j)+θ1∇⋅b→1k+1(i,j)−θ1∇⋅w→1+θ1(r1(i,j+1)+r1(i,j−1)+r1(i+1,j)+r1(i−1,j)))where (i,j) is the position index of the image. We actually use one iteration of the Gauss–Seidel method to handle the discrete Poisson equation. The SOR and FFT can also be used for the equation. We choose to use Gauss–Seidel as it is easier to implement and also efficient compared with other solvers.The terms of the functional in Eq. (10) that involvew→1can be written as:(14)E(w1)=∫Ωβ1|w→1|+θ12|w→1−∇r1−b→1k+1|2dx.Using soft threshold formulation, we get:(15)w→1=∇r1+b→1k+1−β1θ1w→1|w→1|.By generalized shrinkage formula [33], we get:(16)w→1k+1=max⁡(|A|−β1θ1,0)⋅A|A|whereA=(∇r1+b→1k+1).The terms of the functional in Eq. (10) that involvel1can be written as:(17)E(l1)=∫Ω12(s−r1−l1)2+α12|∇l1|2+μ12l12dx.The corresponding Euler–Lagrange equation and the boundary condition is:(18){−s+r1+l1+μ1l1−α1Δl1=0inΩ∇l1⋅n→=0on∂Ω.Discretizing Eq. (18), we get the update equation ofl1.(19)l1(i,j)=1(1+μ1+4α1)(s(i,j)−r1(i,j)+α1(l1(i,j+1)+l1(i,j−1)+l1(i+1,j)+l1(i−1,j))).For solvingr2,l2, the procedure is as same as solvingr1,l1.For solving Eq. (8), we also introduce auxiliary vector variablev→and Bregman iterative parameterd→. Then Eq. (8) can be transformed into:(20)(ϕk+1,d→k+1)=argmind→,ϕ∈[0,1]{λ∫Ω|v→|dxdy+∫ΩR(u1,u2)ϕdxdy+θ2∫Ω(v→−∇ϕ−d→k+1)2dxdy}whered→k+1=d→k+∇ϕk−v→k.This equation can be also solved by alternating minimization method.Fixingv→, the energy function with respect to the variable ϕ is:(21)ϕ=argminϕ∈[0,1]{∫Ω(R(u1,u2)ϕdxdy+θ2(v→−∇ϕ−d→k+1)2dxdy)}.The associated Euler–Lagrange equation, with null-Neumann boundary conditions is:(22){θ(Δϕ+∇⋅d→k+1−∇⋅v→)−R(u1,u2)=0inΩ,(v→−∇ϕ−d→k+1)⋅n⇀=0on∂Ω.The discretization of ϕ can also be got by implicit difference scheme:(23)ϕk+1(i,j)=(11+4θt)t(θ(ϕk(i−1,j)+ϕk(i+1,j)+ϕk(i,j−1)+ϕk(i,j+1)+∇⋅d→k+1(i,j)−∇⋅v→k(i,j))−R(u1,u2))where t is the time step and we sett=1in the whole paper. Then we construct ϕ by projecting it on[0,1], that is:(24)ϕk+1=PC(ϕ˜k+1),wherePC(f(x))=0iff(x)<0,PC(f(x))=1iff(x)>1andPC(f(x))=f(x)iff(x)otherwise.Fixing ϕ to solvev→, the energy function can be changed into:(25)v→=argminv→{λ∫Ω|v→|dxdy+θ2∫Ω(v→−∇ϕ−d→k+1)2dxdy}.By using Euler–Lagrange equation, we get the following equation:(26)v→k+1=∇ϕk+1+d→k+1−λθv→k+1|v→k+1|.By using generalized shrinkage formula [33], we get the update function for variable ofv→k+1:(27)v→k+1=max⁡(|∇ϕk+1+d→k+1|−λθ,0)∇ϕk+1+d→k+1|∇ϕk+1+d→k+1|.At the end of the procedure, we need a threshold τ to segment ϕ into two parts.ϕ=1corresponds to the segmentation target andϕ=0corresponds to the background.We use Eq. (28) to segment the foreground and background:(28)ϕ(x)={0ϕ(x)≥τ,1ϕ(x)<τ.Thus the texture and the background can be separated. Algorithm 1outlines our proposed model of Retinex theory based active contour model for bias segmentation.To evaluate the performance of our proposed method, we test it on some real and medical images. All of the experiments are performed on a personal computer (Intel(R) Core(TM), CPU i7-3930K 3.2 GHz, Memory 16.00 GB) with Windows 7 platform using Matlab 2010. Fig. 1 shows two images with inhomogeneous illumination and the images can be decomposed into illumination and reflection parts using Eq. (3). Fig. 2illustrates the proposed model for segmenting inhomogeneous images with good results. The segmentation is guided by reflection and illumination.Figs. 3 to 6show segmentation results from different methods (including convex CV model [21] and local CV model [35]) and ours, for images with gradually increasing level of complexity, allowing for a visual comparison of the different methods. The results of the two models are the same though convex CV model does not need initialization. Both models use mean values at the inside and outside of the curve, so they are not fit for segmenting inhomogeneous images. Local CV model however is excellent at inhomogeneous image segmentation.Fig. 3 shows the results of different methods on a synthetic image with three objects. The similarity measure is defined as the segmented pixels accounting for pixels actually belong to the foreground objects. The accuracy of our method is 97.8% while convex CV is 71.3% and local CV is 96.6% compared to the ground truth. Fig. 4 is the comparison result using different methods for a real image. The convex CV model cannot segment the image. The local CV model can do better, but still gets it wrong in the upper left of the image. Fig. 5 shows the results for two blood vessel images which have intensity inhomogeneity. The blood vessel is thin and with weak edges which is hard for segmentation. Our proposed model still obtains better results compared with the other methods.Fig. 6 is the results of other two medical images. The first line is heart-CT image segmentation and the second line is MR brain image segmentation. The intensity inhomogeneity of the two images is very strong and the edges are weak. Our proposed model still obtains clearly more satisfactory results compared with the other methods. Medical images are normally distorted by a illumination field which is somewhat similar to global illumination field. Retinex algorithm is modeled based on the global illumination field. That is why the proposed Retinex based segmentation model works very well on these images.We show the time consumption of convex CV model, local CV model, the Split-Bregman method and traditional gradient descent method in Table 1to evaluate the efficiency of the proposed model which is solved by the Split-Bregman method. From Table 1, it is clear that in every iteration, the time consumption of the Split-Bregman method is less than that of traditional gradient descent method. The reason is that with the Split-Bregman method, only a simple alternating optimization involving soft thresholding is needed in every iteration step. From number of iterations, we can also see that the speed of convergence using the Split-Bregman method is much faster than that using traditional gradient descent method. The time consumption in every iteration step of our model is longer than Convex CV and local CV models, because there are many variables need to be updated. However, our model usually converges after a small number of iterations, and the total time consumption is not large.

@&#CONCLUSIONS@&#
