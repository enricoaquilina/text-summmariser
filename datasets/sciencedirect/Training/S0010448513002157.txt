@&#MAIN-TITLE@&#
Compensation of geometrical errors of CAM/CNC machined parts by means of 3D workpiece model adaptation

@&#HIGHLIGHTS@&#
Geometrical inaccuracies are reduced by adaption of the 3D workpiece model.3D model adaption is analogous to a truss structure with compliant constraints.There is reduced criticality of the finishing pass.There is automatic regeneration of tool trajectories using commercial CAM.The approach is compatible with proprietary and access-restricted numeric controls.

@&#KEYPHRASES@&#
Machining,Error compensation,3D Model adaptation,Computer aided manufacturing,

@&#ABSTRACT@&#
In modern industry conditions, it is very important to develop methodologies for reducing costs and achieving the maximum quality of machined parts, especially considering the dimensional accuracy of workpieces. Geometrical and dimensional inaccuracies are due to several factors, such as workpiece and tool deformation during machining, thermal distortions, tool wear, and machine tool inaccuracy. There are two main approaches used to improve the accuracy of workpieces: mapping the tool–workpiece displacement and altering the finishing tool path or the interpolated tool position to compensate the dimensional errors. The aim of this paper is to propose a new compensation approach, based on adaptation of the geometrical 3D CAD model used to generate trajectories by CAM software. The concept is to produce a first workpiece using a CAM-generated tool path. Then, the workpiece is measured using optical methods and the displacements between the ideal workpiece model and the measured point-cloud are calculated. Eventually, the displacement vectors are applied to calculate a compensated workpiece model. Such model is then used as a reference by CAM software to calculate the compensated tool path, which is applied for production of subsequent workpieces. The mathematical background and implementation details are given together with an example of application to a benchmark workpiece purposely machined with inaccurate tools. As the results show, the new approach was able to compensate the geometrical inaccuracies of the benchmark workpiece.(14)Kj=∑i=1M([∂∂x(Δxj′,i′(Δll)j′,i′)∂∂y(Δxj′,i′(Δll)j′,i′)∂∂z(Δxj′,i′(Δll)j′,i′)∂∂x(Δyj′,i′(Δll)j′,i′)∂∂y(Δyj′,i′(Δll)j′,i′)∂∂z(Δyj′,i′(Δll)j′,i′)∂∂x(Δzj′,i′(Δll)j′,i′)∂∂y(Δzj′,i′(Δll)j′,i′)∂∂z(Δzj′,i′(Δll)j′,i′)]|Pj)

@&#INTRODUCTION@&#
Reduction of production cost is essential for enhancing the competitiveness of manufacturing companies. Demands in terms of quality and geometrical accuracy are constantly increasing and it is very important to develop methodologies for reducing the set-up time of new products and adjust production settings to achieve the maximum quality.For machined parts, quality is strongly related to dimensional accuracy, which depends on several factors, such as: tool condition, tool and workpiece zero setting and position accuracy, machine tool thermal distortions, geometrical inaccuracies of the machine, machine wear, static deflection of machine components and many others. Therefore, it is important to develop methodologies for identifying and compensating such disturbances in order to improve the quality level.Many machine tool producers propose sophisticated strategies for reducing some causes of inaccuracy, however there are many aspects which have to be dealt with directly by the machine tool user. For instance, errors in the tool and workpiece positioning or set-up, workpiece and tooling structure deformation, tool wear and thermal distortion of the tool/tooling structure and workpiece are usually not handled by the machine tool control unit.The aim of this paper is to propose a new approach for automatic compensation of geometrical and dimensional inaccuracies based on adaptation of the workpiece 3D model, which is illustrated in Fig. 1in comparison to conventional methods. First, an extensive overview of the state of the art methodologies is given. Then, the concept of the new approach is presented together with its mathematical description. Finally, the approach is experimentally validated by machining a benchmark workpiece.After an analysis of the literature dealing with methodologies for geometrical and dimensional error compensation of machining operations, the state of the art was obtained, which is synthetized in Table 1. The table is organized in order to indicate the bibliographic reference, year of publication, the causes of dimensional error, the surface measurements errors, type of machining strategies–2D means contouring milling or turning, 3D means sculptured surface milling with three or more axes–and the error correction strategy.According to literature review, the main causes of dimensional errors in machined parts can be classified into three categories: machine tool inaccuracy, tool and workpiece deflection and thermal deformation. Machine tool inaccuracy involves machine static deflection, erroneous axis control due to axis flexibility and inaccuracy of machine tool assembly. Tool and workpiece deflection is caused by relatively high cutting forces and by inadequate stiffness of tooling system or fixture. Another important source of dimensional errors is the thermal distortion of the machining system caused by the cutting process and by the mechanical power dissipated by the machine tool.Optical or contact methods are usually applied for measuring the machine tool inaccuracy and/or the workpiece dimensional errors. Optical methods can be used to obtain, without contact, a list of tridimensional coordinates of the workpiece surface points. Alternatively, the workpiece can be inspected on a Coordinate Measuring Machine (CMM) by using contact methods, i.e. by using a touch probe. Optical approaches are quite fast, however they are rather inaccurate compared to contact inspection methods. Recently, some authors managed to apply the touch probe directly in the machine tool  [7,8]. This is a practical approach, however the measure is affected by the errors of the machine tool.As can be clearly seen in Table 1, the error correction strategies are tool path compensation and interpolator compensation. Tool path compensation consists in modifying the tool path points–this is generally performed only for finishing operations–in order to reduce the geometrical inaccuracies. This method can compensate all types of dimensional inaccuracies under the hypothesis that they are repeatable. This can be either obtained by modifying the Cutter Location (CL) data  [3,6] or the Numeric Control (NC) code[4,5,10,12,13,17,18]. The machining process is first executed with the nominal uncompensated tool path. Then, surface errors are measured, for instance on a CMM. A corrected tool path is generated and applied for machining of subsequent workpieces. Tool path modification is obtained by translating the control points by the same amount of the measured error. The finishing pass has to compensate both workpiece inaccuracy and tool/workpiece deflections that occurred during the previous passes, as shown in Fig. 2. Therefore, an augmented finishing allowance is present in the finishing pass which may cause problems, especially when slender tools are used. In addition, it is very difficult to apply this solution in industrial conditions since the tool paths generated by commercial CAM software are difficult to modify by means of control points.Alternatively, the displacement map of tool position as a function of the coordinates can be determined by measuring machined workpieces or estimating the tool position inaccuracy, during void movements, using high precision optical methods such as laser interferometry  [9]. The displacement map is subsequently applied to modify the finishing part program or, alternatively, to correct the interpolated tool path. It has to be pointed out that displacement maps obtained using high precision optical methods are not suitable to compensate inaccuracies derived from machining operations, such as deflections and thermal expansion of the tool and workpiece. The interpolator compensation approach is seldom feasible since many numeric controls applied in industry are proprietary and there are strong restrictions which prevent customization. Moreover, the mathematical models applied for compensation are generally very rough and inaccurate.An overview of the proposed approach and its integration into a conventional production system is given in Fig. 3. Using an STL model, the first workpiece is produced conventionally. Then, the measurement and inspection data of the first workpiece is used to derive an adapted workpiece 3D model, which is applied in the CAM software to generate a compensated tool path to be applied for further production. Specifically, the adapted workpiece 3D model is obtained, starting from a registered point cloud of the first workpiece, through the following phases:•generation of displacement vectors;elimination of registration errors;compensation of the workpiece model.The main aim of this phase is to obtain a raw displacement vectorvjd,Raw–i.e. the displacement between the theoretical and effective position–for each vertexjof the original STL model of the workpiece in comparison to a point cloud derived from dimensional measurements of the machined workpiece. The point cloudPCshould first be aligned to the STL model by using a point-cloud processing software such as 3D Reshaper or MeshLab.The algorithm is composed of the following activities. For each vertex of the STL model, the set of pointsPCSincluded in a sphereSof radiusRScentered on the vertex is determined, as shown in Fig. 4(a). Successively, the set of triangles surrounding the vertex are extracted from the STL file and classified according to their face normal, as illustrated in Fig. 4(b). In this way, the list of planes in the surrounding of the vertex is determined and, according to the number of planes, it is known whether the vertex is located on a surface, edge, or corner of the STL. Then, each plane is translated in order to interpolate the largest number of points belonging toPCS. According to the vertex position, the displacement vector can be defined in the following ways:(a)single plane or surface–for the Euclidean distance vector between the STL vertex and the plane;two planes or edge–for the distance vector between the STL vertex and the planes intersection line;three planes or corner–for the vector between the STL vertex and the three planes intersection point;four planes or more–for the vector between the STL vertex and the barycenter of all three planes intersection points.For a successful evaluation of displacement vectors, it is critical that the number of pointsnpinside the sphereSis sufficiently high and evenly distributed among planes. Plane interpolation is in fact unreliable if based on a low number of points (from the author’s experience less than 5 points), and the method cannot be applied. In order to illustrate this, let us consider a sphereSof radiusRSand a planePlocated at a distanced≤RSfrom the sphere center. Let us suppose that point are evenly distributed around planePwith densityρexpressed as point per square millimeter (pt/mm2). Thus, the average number of pointsnp,Pinside the sphereScan be estimated as follows:(1)np,P=πρ(RS2−d2)=πρRS2(1−d2RS2).Since the sphere radiusRSis limited by the workpiece dimensional complexity, an adequate number of points has to be achieved by increasing the surface point densityρand limiting thedRSratio.To test the influence of the superficial point densityρ, the sphere center-plane(s) distancedand sphere radiusRS, a preliminary investigation was performed. The cases “surface”, “edge” and “corner” were considered to test the performance of the algorithm for evaluation of displacement vectors by simulating artificial displacements of entitydeff. A complete Design of Experiments (DoE) was performed with displacementdeffon 11 levels (from 0.05 to 1.0 mm), surface point densityρon 4 levels (5, 10, 20 and40pt/mm2) and 1000 repetitions. In each repetition, the displaced point cloud was generated randomly and random noise∼N(μ=0,σ=0.03)was added to each point of the point cloud to simulate the measurement error. For each combination of factors, the mean of the displacement errorϵd, the±2σconfidence interval ofϵdand the percentage successful elaborations were calculated. The sphere radiusRSwas 1 mm. The results of the preliminary verification of the evaluation of displacement vectors are given in Fig. 5.For the “surface” case, the performance of the algorithm was very good in almost all tests, since the mean of the displacement errorϵdwas 0, the confidence interval was constant and the percentage of successful elaborations was 100% fordeffRS≤0.9. In the “corner” and “edge” cases good results were obtained only when the surface point density wasρ≥20pt/mm2anddeffRS≤0.7.According to these preliminary results, it was possible to establish that, for a sphere of radiusRS=1mmthe surface point densityρhas to be at least20pt/mm2and the maximum distance between the STL vertex and the point cloud has to be lower than0.7RS.Since the alignment of the STL and the point cloud is not exact, the displacement vectorsvjdmay be affected by the mismatching errors, as follows:(2)vjd,Raw=vjd+vjd,RBMwherevjdis the proper deformation due to the inaccuracies of the machining process andvjd,RBMis the mismatching error which can be described as a Rigid Body Motion (RBM). Thevjd,RBMshould be evaluated and eliminated if not negligible. It can be written as follows:(3)vjd,RBM=vjd,TRA+α∧(Pj−P0),wherePjis the position of the generic nodejof the STL. Thevjd,TRArepresents a pure translation while the second term represents a pure rotation–described by the rotation vectorα–with respect to the STL vertices barycenterP0. The first term may be simply evaluated by calculating the arithmetic mean of the displacement vectorsvjd,Raw. Under the hypothesis of small displacements, the rotation term is a linear combination of rotation vector components which can be estimated by regression, as follows:(4)α̂=(HTH)−1(HTYV),where, withNvertices in the STL, the dimension of matrixHis3N×3and the dimension of matrixYVis3N×1; in detail,(5)H=[0Pj,y−P0,yPj,z−P0,zPj,z−P0,z0−Pj,x+P0,x−Pj,y+P0,y−Pj,x+P0,x0]wherePj,w(w=x,y,z) are the column vectors of coordinates of the STL vertices,P0,w(w=x,y,z) are the coordinates of the barycenterP0, and(6)YV=[vjd,Raw,xvjd,Raw,yvjd,Raw,z]wherevjd,Raw,w(w=x,y,z) are the column vectors of raw displacement vectors components. The compensated displacement vectorsvjdare then obtained by removing the estimatedv̂jd,RBMfromvjd,Raw.In order to apply a smooth deformation of the STL vertices, an original approach for STL model compensation based on the solution of an equivalent truss structure with compliant constraints was applied. The concept of the approach is represented in Fig. 6.The vertices of the STL become the joints of an equivalent truss structure, which is also composed of beams of elastic moduluskb—one beam for each link between STL vertices, and compliant constraints of elastic moduluskcconnecting each vertex to the rest position of the compliant constraint.The compensated STL vertices positions are obtained by solving the equilibrium equation of the truss structure.The rest positionPjdof the compliant constraint for the generic nodejis obtained by subtracting the measured displacement vector from the initial position, i.e.(7)Pjd=Pj−vjd.LetPj′be the final point of the compensated STL addressing to thejth node. Let us define the generic vector difference:(8)ΔPr,s=Pr−Ps=[Δxr,sΔyr,sΔzr,s],r,s=i,i′,j,j′,jd.The relative elongation of the beam connecting nodejto nodeican be written as follows:(9)(Δll)j′,i′=|Pj′−Pi′|−|Pj−Pi||Pj′−Pi′|.Therefore, the equilibrium equation for the generic nodejof the truss becomes(10)Fj′=kb∑i=1M(Pj′−Pi′)(Δll)j′,i′+kc(Pj′−Pjd)=0,whereMis the number of nodes connected to the nodej. Taylor expansion truncated at first order was applied to linearize the equilibrium equation, as follows:(11)Fj′≅Fj′|Pj+∂Fj′∂x|PjΔxj′,j+∂Fj′∂y|PjΔyj′,j+∂Fj′∂z|PjΔzj′,j=Fj′|Pj+[∇(Fx,j′)∇(Fy,j′)∇(Fz,j′)]|Pj⋅ΔPj′,j=0,where(12)Fj′|Pj=kc(Pj−Pjd)=kcvjdand(13)[∇(Fx,j′)∇(Fy,j′)∇(Fz,j′)]|Pj⋅ΔPj′,j=kb∑i=1M{[∇(Δxj′,i′(Δll)j′,i′)∇(Δyj′,i′(Δll)j′,i′)∇(Δzj′,i′(Δll)j′,i′)]|Pj}⋅ΔPj′,j+kc[∇(Δxj,jd)∇(Δyj,jd)∇(Δzj,jd)]|Pj⋅ΔPj′,j.The first summation of Eq. (13) can be expressed as Eq. (14) given in Box I: this, under the hypothesis of small displacements, can be also expressed as(15)Kj=∑i=1M([Δxj,i2lj,i2Δxj,iΔyj,ilj,i2Δxj,iΔzj,ilj,i2Δxj,iΔyj,ilj,i2Δyj,i2lj,i2Δyj,iΔzj,ilj,i2Δxj,iΔzj,ilj,i2Δyj,iΔzj,ilj,i2Δzj,i2lj,i2]).The second term of Eq. (13) can be rewritten as follows:(16)[∇(Δxj,jd)∇(Δyj,jd)∇(Δzj,jd)]|Pj⋅ΔPj′,j=I⋅ΔPj′,j=(Pj′−Pj).Therefore the Eq. (13) becomes(17)Fj′≅kc(Pj−Pjd)︸vjd+kbKj(Pj′−Pj)+kc(Pj′−Pj)=0.By adding and assembling the equilibrium equations of each node in a linear system, the overall square structure matrixKof dimension3N, is obtained:(18)(kbkcK+I)[P1′−P1P2′−P2⋮PN′−PN]+[v1dv2d⋮vNd]=0,whereNis the number of nodes. The equilibrium configuration is obtained as follows:(19)[P1′P2′⋮PN′]=[P1P2⋮PN]−(kbkcK+I)−1[v1dv2d⋮vNd].As can be seen the equilibrium equation depends on thekb/kcratio which determines the compromise between effective compensation of the displacement and preservation of the model shape. An example of the difference between the original model, displacement vectors and the new model is given in Fig. 7.The automatic regeneration of tool trajectories is based on direct substitution of the reference to the file of CAD model used by the CAM software for calculating offset and collision detection. This is possible when the CAM software allows a reference to an external file for this specific purpose. For instance, the following procedure was adopted by the CAM software used in this paper (OPEN MIND HyperMILL). Firstly, a CAD model of the workpiece was given as input to the CAM software. This was used as a static reference for visualization and boundaries definition. Then, another model–linked as external reference–was assigned for tool trajectory calculation and collision detection. An example of re-calculated trajectories is given in Fig. 8.However, it should be noticed that this approach may not be applicable for machining strategies which are based on feature recognition.The error compensation approach was validated using a benchmark workpiece designed for the purpose, which is shown in Fig. 9. The 3D CAD model of the workpiece, shown in Fig. 9(a), was generated in Siemens Solid Edge ST5 environment and exported in STL file format. Since the CAD software automatically minimizes the number of triangles, the obtained STL was not uniformly meshed, see Fig. 9(b). Accordingly, the STL file was further processed in Mathworks Matlab in order to obtain a remeshed STL, with a more uniform vertex distribution, which is illustrated in Fig. 9(c). The remeshing algorithm consisted in splitting iteratively each triangle whose longest side was longer than 2 mm into smaller triangles and an STL with 56950 vertices and 113896 faces was obtained.The remeshed STL was then imported and linked in CAM environment and the list of working cycle strategies was defined. The stock was a cylindrical workpiece of 100 mm diameter and 55 mm height made of Al 6068 aluminum alloy. The list of machining strategies and cutting parameters is given in Table 2, whereas tool details are reported in Table 3. After machining strategies definition, the tool trajectories were automatically calculated by CAM and a CL file was obtained. An example of the tool trajectories generated by CAM is given in Fig. 10(a).In order to produce a workpiece with a significant dimensional inaccuracy and test the capabilities of the proposed automatic compensation approach, the diameters of the tools defined in the CAM software were slightly different from the diameters of the tools applied for machining, as highlighted in Table 3. Specifically, a 0.2 mm larger tool diameter was specified in the CAM environment to the cylindrical end-mill, tool 2. Similarly, a 0.1 mm larger nose radius was assigned to the hemispherical end-mill, tool 4. By so doing, a residual stock material was left by the cutting process, simulating the effect of a significant tool deflection, tool wear, wrong tool selection or wrong tool presetting. It is important to point out that only the radial tool position was affected, whereas the axial tool position was exact. Axial inaccuracies were neglected since they are not realistic.The CL file generated by CAM was post-processed and machining operation was performed on an Okuma Multus B300W multi-function CNC center, as shown in Fig. 10(b).The machined workpiece, which is illustrated in Fig. 11(a), was scanned by Konica Minolta Range 7 3D laser optical system (accuracy±30μm) and also measured by a Zeiss Accura Coordinates Measuring Machine (CMM, accuracy±2μm) for reference. A point cloud with 624436 points was obtained for a workpiece surface of about31220mm2.The point cloud and the STL model were imported in Mathworks Matlab environment for elaboration with a sphere radiusRSof 1 mm. The calculated displacement vectors are shown in Fig. 11(b). The elaboration was carried out on a 2.20 GHz quad-core processor using Matlab parallelization toolbox functions and required about 10 min for calculation of displacement vectors and about 4 min for calculation of compensated STL model.The point cloud and the STL of the workpiece were aligned using commercial software and the residual registration errors (maximum magnitude around32μm) were eliminated.In order to select a suitablekb/kcratio, a design of experiments was performed. Different compensated STL models were generated for each value ofkb/kcratio as shown in Table 4, and used to regenerate the tool trajectories using HyperMILL CAM software, as described in the previous section. The tool geometries specified in CAM system were not modified.An external geometrical simulator was applied to simulate machining using NC part programs generated by HyperMILL post-processor. At the end of the simulations, the machined workpieces models in STL file format were obtained.By comparing the simulated STL workpiece model obtained by simulation with the original 3D model for eachkb/kcratio, the displacement map and average absolute displacement were computed, as shown in Figs. 12 and 13.It is possible to observe that the average absolute displacement was increasing for increasing values of thekb/kcratio. Therefore, the ratio should be chosen as close as possible to 0. However, for very smallkb/kcratios, some problems were detected in the simulated STL which are highlighted in Fig. 14. These problems were caused by inaccuracies in the workpiece measurement or in the calculation of the displacement vectors which were not sufficiently filtered out by the compensation approach and thus produced a defective tool trajectory. A good balance between the amount of the compensation and the preservation of the geometry of the compensated STL waskb/kc=0.2.A second physical workpiece was machined with the relative NC using the compensated tool trajectories and then measured. According to the CMM measurement of the second workpiece, a satisfactory compensation of geometrical inaccuracies affecting the first workpiece was achieved. An example of the CMM measurement of a section of the hemispherical part of the first and second workpiece is given in Fig. 15.

@&#CONCLUSIONS@&#
In this paper, an innovative methodology for automatic compensation of geometrical and dimensional errors of machined mechanical parts, based on workpiece 3D CAD model adaptation, has been presented. The concept of the method and the complete mathematical background for its implementation have been illustrated.The core of the method is an innovative algorithm for altering the 3D STL model of the workpiece in order to compensate its geometrical inaccuracies. It is based on the determination of the displacement vectors for each vertex of the STL and the solution of the equilibrium equation of an equivalent truss structure with compliant constraints. The ratio between the stiffness of truss beams and that of compliant constraints was critical to obtain a smooth compensation without defects.Also, for automatic regeneration of the tool trajectory with a commercial CAM system, the CAM environment should fulfill some requirements. Specifically, it should be able to handle the workpiece model as an external reference. In this way, the compensated model was applied for regeneration of trajectories simply by updating the reference.For validation, the innovative methodology was applied to a real benchmark workpiece whose first prototype was machined with wrong tool geometry specifications. With the obtained compensated tool trajectory, an accurate workpiece was machined.The results show that the approach is feasible and it can be integrated in a relatively simple way in enterprise engineering procedures. However, its applicability is mainly limited to correction of macroscopic errors due to the need of fast and high density surface measurement tools, such as optical scanning devices, which are quite imprecise. With the availability of more precise superficial scanning techniques, the range of application of the method could be extended.Another interesting future development would be to integrate the method into CAM software, thus compensation may be applied during tool path calculation directly.It will be of further interest to continue the research in this field by improving the methodology in order to create an integrated system for automatic compensation of geometrical inaccuracies.