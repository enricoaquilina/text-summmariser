@&#MAIN-TITLE@&#
Automatic multiple sclerosis lesion detection in brain MRI by FLAIR thresholding

@&#HIGHLIGHTS@&#
An algorithm for multiple sclerosis lesion detection in brain MRI is presented.An initial segmentation of brain tissues is performed by a modified EM algorithm.Lesions are located as outliers of the grey matter FLAIR intensity distribution.45 cases from three different scanner machines were used to evaluate the algorithm.The results show a moderate agreement between manual and automatic detections.

@&#KEYPHRASES@&#
Multiple sclerosis,Lesion segmentation,MRI,

@&#ABSTRACT@&#
Magnetic resonance imaging (MRI) is frequently used to detect and segment multiple sclerosis lesions due to the detailed and rich information provided. We present a modified expectation-maximisation algorithm to segment brain tissues (white matter, grey matter, and cerebro-spinal fluid) as well as a partial volume class containing fluid and grey matter. This algorithm provides an initial segmentation in which lesions are not separated from tissue, thus a second step is needed to find them. This second step involves the thresholding of the FLAIR image, followed by a regionwise refinement to discard false detections. To evaluate the proposal, we used a database with 45 cases comprising 1.5T imaging data from three different hospitals with different scanner machines and with a variable lesion load per case. The results for our database point out to a higher accuracy when compared to two of the best state-of-the-art approaches.

@&#INTRODUCTION@&#
Conventional magnetic resonance imaging (MRI) techniques are highly sensitive for detecting brain abnormalities, like multiple sclerosis (MS) plaques, and can provide quantitative assessment of inflammatory activity and lesion load. MRI-derived metrics have become established as the most important paraclinical tool for a large variety of applications, like brain lesions diagnosing and monitoring [24], longitudinal studies of cognitive aging [16], or even the analysis of the fetal brain development [28]. MRI offers a high contrast between the main brain tissues, namely grey matter (GM), whitte matter (WM), and the cerebrospinal fluid (CSF).For a quantitative analysis of focal MS lesions in both individual and temporal studies, manual or semi-automated segmentations of different MR images have been used to compute the total number of lesions and the total lesion volume. Manual delineation of MS lesions, however, is both challenging and time-consuming because of the large number of MRI slices for each patient that compose the three-dimensional information. Moreover, it is prone to intra-observer variability (the same study analysed by the same neuroradiologist at a different time) and inter-observer variability (the same study analysed by different neuroradiologists).The development of fully automated white matter lesions detection methods, which can segment large amounts of MRI data and do not suffer from intra- or inter-observer variability, is not a new topic [19] but nowadays it is still an active research field [13,21,22,25]. These approaches can be classified between supervised and unsupervised algorithms. The inherent advantage of supervised algorithms is that they can automatically learn the characteristics of both normal tissue and lesions. However, their main problem is that they rely on having a good training set, which may be difficult to obtain. Two supervised strategies can be identified according to the procedure the annotations are introduced into the algorithms: using an atlas registration step or training a classification algorithm. The advantage of atlas-based approaches is that spatial information is inherently used, although registration is also a challenging task. On the other hand, training-based approaches allow to use real characteristics of the tissues and the lesions, but spatial information has to be imposed in a further step since it is not included in the training process.The expectation-maximisation (EM) [8] algorithm is one of the most widely used in the literature for tissue segmentation with atlases [6]. For instance, Souplet et al. [35] adapted the EM algorithm to tackle partial volume (PV) effects and segment lesions. In their approach, which is an extension of the algorithm presented by Dugas-Phocion et al. [10], two main types of classes are defined: pure tissue classes, which are assumed to follow a Gaussian distribution and comprise CSF, GM, and WM; and partial volume classes, which are defined as proportions between GM and CSF. While other interactions may occur (such as WM and CSF around the ventricle boundaries), those are excluded due to their slight influence and the possibility of defining them using CSF and GM proportions.In this paper, we will further explain the basics of this approach and present our contributions, introduced as part of our lesion segmentation pipeline. These contributions comprise a similarity map to weight the atlas, the use of neighbourhood information combined with the weighted atlases, the introduction of a partial volume probability map, and a regionwise false positive reduction step based on clinical rules. All the steps in the proposed pipeline are applied to the images after the preprocessing. The rest of the paper is structured as follows: in Section 2 our database is described and all the preprocessing and segmentation steps are explained, in Section 3 we present our parameter tuning with the quantitative and qualitative results obtained with our database consisting of 45 patients followed by a comparison with two state of the art techniques [30,35]. Finally, conclusions are presented in Section 4.Our database comprises images from three different hospitals to evaluate the performance of the proposed automatic segmentation of brain tissues and lesions in different scanning machines. For each hospital, 15 different patients were scanned with the same protocol (T1-w, T2-w, PD-w and FLAIR): from Hospital Vall d’Hebron (H1), using a 1.5T Siemens Simphony Quantum with 2D conventional spin-echo T1-w (TR 450ms, TE 17ms), dual echo PD T2-w (TR 3750ms, TE 14 / 86 ms), and FLAIR (TR 9000ms, TE 114ms, and TI 2500ms); from Hospital Josep Trueta (H2), using a 1.5T Philips Intera (R12) with 2D conventional spin-echo T1-w (TR 653ms, TE 14ms), dual echo PD T2-w (TR 2800ms, TE 16 / 80ms), and FLAIR (TR 8153ms, TE 105ms, and TI 2200ms); and from Clínica Girona (H3), using a 1.5T GE Signa HDxt, with 3D fast spoiled gradient T1-w (TR 30ms, TE 9ms), fast spin echo T2-w (TR 5000-5600ms, TE 74-77ms), PD-w (TR 2700ms, TE 11.9ms), and FLAIR (TR 9002ms, TE 80ms, and TI 2250ms). All the images were acquired in axial-view with a slice thickness of 3mm (1mm × 1mm × 3mm) and were co-registered using an affine transform.From each hospital, patients with different lesion load were scanned as illustrated in Fig. 1. By looking at the bar plot, there is a clear difference between the lesion load among the three hospitals. H1 showed the lowest mean (3.1cm3) and median lesion load (1.62cm3) per patient. On the other hand, H2 has the highest mean (18.03cm3) and median lesion load (10.54cm3) of all three hospitals. This hospital also has a high variability in terms of lesion load. For instance, the minimum and maximum lesion loads are 0.19cm3 and 52.48cm3 respectively. The last hospital, H3, presents a mean (10.34cm3) and median (5.03cm3) value in-between the other two hospitals. Furthermore, the lesion load of these cases presents a similar variability to H1, even though H3 has the case with the highest lesion load of all three hospitals with 67.78cm3. Looking at all 45 patients, most have a lesion load lower than the mean lesion load for each hospital. This is due some of the cases having an exceptionally higher lesion load than the other cases handled at each hospital.All the lesions of each patient were accurately annotated by a trained technician and confirmed by expert radiologists from H1. All the annotations were done on the PD-w images and semiautomatically delineated using JIM© software11Xinapse Systems, JIM software webpage, http://www.xinapse.com/home.php.. These annotations will be used as ground truth (GT).The presence of non-brain tissues affects intensity distributions in the image. It is not clear how the probability density function of each main tissue (GM, WM, and CSF) is altered by these external intensities, but segmentation results are usually improved when those voxels are masked out. There are different available methods to perform this step [3,32,34], although none of them has been shown to be superior to the others. In our pipeline, we decided to apply the BET algorithm [34] to remove these tissues. BET, a tool from the FSL toolbox [17], is a freely available algorithm based on T1-w images and is widely used in brain MRI processing.A robust and automatic brain MRI segmentation is difficult to achieve due to numerous facts: variable imaging parameters, overlapping intensities, noise, partial volume effects, gradients, motion, echoes, blurred edges, normal anatomical variations, and susceptibility artefacts [31]. This can lead to inaccurate segmentation. However, from the image processing viewpoint, it is common to simplify all these problems [18,33] by defining the observed intensities,Iˆ, of each voxel x as:(1)Iˆ(x)=βI(x)+ɛwhere I(x) is the real intensity, β is a multiplicative smooth bias field that causes intensity inhomogeneities due to the sensitivity of the reception coil and ɛ represents additive noise. While it is assumed that ɛ follows a Rician distribution [9], there have been different approaches to correct the bias field β. This is an important issue since voxels belonging to different tissues may be assigned with the same grey-level value when varying this term.Following this model, the first step to recover the real intensity values would be to eliminate, or reduce, the noise signal since the bias field is assumed to affect the original intensity values independently of the noise. Therefore, after the skull stripping, we use an anisotropic diffusion filter that tends to preserve edges over smoother regions according to the gradient magnitude at each point. This filter is part of the Insight toolkit (ITK) software library22Publicly available at http://www.itk.org.and is implemented as an N-dimensional version of the classic Perona and Malik anisotropic diffusion equation for scalar images [26].After noise reduction, the only issue from Eq. (1) that remains is the multiplicative bias field. Amongst the various bias correction algorithms that deal with this smooth multiplicative field, the well-known nonparametric nonuniform normalisation (N3) [33] has become a de facto standard for a variety of imaging acquisition strategies. Recently, Tustison et al. [37] proposed two improvements to this method and a new implementation renamed Nick's N3 (N4) based on the ITK library. These two major changes affect the B-splines modelling and the iterative optimisation scheme. Summarising, we decided to use the N4 bias correction filter combined with the anisotropic diffusion filter to recover the original intensity image I(x). We applied both filters to all the images (PD-w, T1-w, T2-w and FLAIR).Rigid registration is usually sufficient when dealing with intra-subject medical applications, such as temporal studies of the same subject. However, when dealing with inter-subject applications, such as atlas matching, nonrigid algorithms can explain local anatomical variations between the template and the subject brain that global methods fail to reproduce [4].In our proposal, we have decided to use the ICBM atlas [12] and implement with ITK one of the most common methods based on a multi-resolution approach [29], with a starting alignment using affine transformations to globally align the atlas template and the patient's scan, followed by a multi-resolution B-spline transformation. Within the registration framework, the mutual information metric is used as part of the optimisation process.When the registration is completed, a similarity volume is computed comparing the moved atlas template and the patient's T1-w image. For both images, we create a patch of 3×3×3 for each voxel and compute a similarity metric between them. Bigger patches produce smoother similarity maps, decreasing the effect of the weighting in the probabilistic maps. The normalised cross-correlation metric is chosen over other similarity metrics due to its invariance to linear intensity brightness, and also to decouple the similarity volume process from the optimisation one and reduce the bias introduced when using the same metrics for both processes. Therefore, the similarity map ϕ(x) is normalised between 0 and 1 by definition and is defined by the following equation:(2)ϕ(x)=∑i∈{x,Nx}(IT1(i)−I¯xT1)(πI(i)−π¯xI)∑i∈{x,Nx}(IT1(i)−I¯xT1)2∑i∈{x,Nx}(πI(i)−π¯xI)2,where IT1(x) is the T1-w image of the patient (used as the fixed image), πI(x) is the atlas template image (used as the moving image).I¯xT1andπ¯xIare the mean intensities of the 3D neighbouring areaNxcentred on pixel x for images IT1(x) and πI(x) respectively, computed as follows:(3)I¯xT1=1|Nx|∑i∈{x,Nx}IT1(i),(4)π¯xI=1|Nx|∑i∈{x,Nx}πI(i).The resulting similarity map expresses a local relation between the resulting transformation and the image we want to segment, highlighting those regions where the deformation adapts to the new case and darkening the regions where the optimisation process could not reach the desired accuracy. Therefore, this map can then be used as a weighting volume for the probabilistic atlases in a similar manner to the fusion step of multi-atlas propagation strategies [2,15].As stated earlier, the original method from Dugas-Phocion et al. [10] proposed to segment the brain introducing the concept of partial volume effects [23]. To that extent, partial volume classes are introduced in what follows.Within this framework, we define the pure tissue class set PT={CSF, GM, WM}. For each class c∈PT, we assume its intensity distribution is modelled as the following multidimensional Gaussian distribution:(5)yc∼N(μc,Σc).As stated in Dugas-Phocion et al. [10] MRI noise can be approximated to a Gaussian distribution, making this distribution a common choice when modelling tissue distributions. Given two pure tissue classes, c1 and c2, a PV voxel x with a proportion α of class c1 (and hence a proportion 1−α of class c2), its intensity I(x) is a random variable yPVthat can be computed asyPV=αyc1+(1−α)yc2. Considering all the PV voxels, α is uniformly distributed, however, if α is set as a constant, yPVfollows the subsequent Gaussian distribution:(6)yPV∼N(αμc1+(1−α)μc2,α2Σc1+(1−α)2Σc2)We assume that the pure tissue distributions that compose the partial volume classes are independent, as was previously addressed and discussed in González Ballester et al. [23]. Since we assume that the bias correction step reduces the effect of intensity inhomogeneities and the underlying tissues have no relationship, we can assume that the intensity distributions obtained using an MRI scanning machine are also independent.Dugas-Phocion et al. [10] and Souplet et al. [35] decided to sample α at different constant values in the range [0, 1] and set c1 and c2 as CSF and GM. A constant for the number of PV classes was defined in order to select those proportions. Furthermore, they introduced two different outlier classes to deal with imaging artefacts. For instance, Dugas-Phocion et al. defined an outlier class to differentiate between what the atlas considers as CSF but is actually a vessel, while Souplet et al. also defined a pure outlier class based on the Mahalanobis distance.While these two strategies reduce the variance of the PV and CSF classes, they create small clusters that do not provide extra information and can sometimes collapse and become an empty set. For example, vessels may not be visible in low resolution images or may be represented by only a few voxels. Therefore, we simplified the partial volume approach fixing α to 0.5 and using only a PV class. In fact, we observed that most artefacts and lesions are classified inside this class, as well as the interfaces between CSF and GM.Initialisation is a crucial aspect of the EM algorithm. Without proper initial parameters the algorithm may take longer to converge or, even worse, reach a local maximum. Commonly, distribution parameters are estimated either semi-automatically or automatically, and the algorithm starts in the expectation step. However, probability maps (such as atlases) can also be used to estimate the initial tissue parameters as part of the maximisation step. This is the case in tissue segmentation approaches that rely on atlas-based segmentation. For instance, Souplet et al., used the registered atlas for pure tissue classes and, afterwards, PV class parameters were calculated following Eq. (6).However, atlas registration may cause several errors close to the cortex region even when using deformable registration. This is due to the high spatial variability caused by the gyri and sulci of the brain. Moreover, lesions are usually masked inside WM due to their nonexistence in healthy tissue atlases, even though they do not share the same intensity distribution.Therefore, initial estimates relying solely on the probabilistic maps after registration may be corrupted by those errors, causing biased initial estimates for the mean and a high variability for each tissue. While those issues can later be overcome with several iterations, reducing them decreases computation time and improves convergence. In our proposal, we combine the atlas probabilities with the similarity map computed during registration and set a threshold Tπto select only those atlas probabilities that are meaningful to the class. As a consequence, not all the voxels are used to initialise the model.In the expectation step, the probability of belonging to the different classes of each voxel is updated with the application of Bayes’ rule:(7)p(c|I(x))=p(I(x)|c)p(c)p(I(x)),(8)p(I(x))=∑c=1Cp(I(x)|c)p(c).being C the total number of classes. As we explained before, each class (including the partial volume class) follows a Gaussian distribution with parameters θc={μc, Σc}, where c∈{CSF, GM, WM, PV}. Therefore, p(I(x)|c) can be estimated using the following probability density function:(9)pˆi(I(x)|c,θˆci−1)=e−12(I(x)−μˆci−1)t(Σˆci−1)−1(I(x)−μˆci−1)(2π)D|Σc|,wherepˆi(I(x)|c,θˆci−1), is the estimation of p(I(x)|c) at iteration i with the parametersθˆci−1estimated at iteration i−1, and D is the number of features. In our case D=3, since we use T1-w, PD-w, and T2-w images, the most commonly used MR images for tissue and lesion segmentation.To compute the priors for each class p(c), Dugas-Phocion et al. proposed two different approaches. If probabilistic atlases are available for all classes, thenp(c)=πcP, whereπcPrepresents the probabilistic map for the class c. On the other hand, when no atlases are available, p(c) is re-estimated at each iteration using the following equation:(10)pˆi(c)=∑x=1Nvoxelspˆi−1(c|I(x))Nvoxels,where Nvoxelsis the total number of voxels. The first approach, introduces a local estimate for each voxel, imposing contextual and spatial constraints, while the second one is a global estimate for all the voxels. However, no hybrid approach was proposed by either Dugas-Phocion et al. or Souplet et al. for when some probability atlases are present (i.e. pure tissue classes). Therefore, we propose to create a PV atlas defined as:(11)πPVP(x)=12(πCSFP(x)+πGMP(x)),since we defined the class PV as an equal proportion of both CSF and GM. With this new atlas, we finally have a probability map for each class that can be used as a local prior probability. However, the probability maps must be normalised again since∑c=1CπcP(x)=1.Registration errors are common when registering a template to a new image. These errors arise from differences in anatomy that cannot be captured by the optimisation procedure and increase when dealing with an outlier class, such as MS lesions, that is not present in the atlas template. To take these errors into account, we compute a similarity map as explained in Section 2.4 to weight the probability maps as priors. However, to reduce the effect of the atlas on those regions where anatomical differences are present, we use another prior estimation since the weighting is applied equally to all classes for each voxel. Therefore, we propose the introduction of a simple neighbouring factor as expressed by the following equation:(12)pˆi(c)=ϕ(x)πcP(x)+(1−ϕ(x))∑j∈Nxpˆi−1(c|I(j))|Nx|.where ϕ(x) represents the similarity map,Nxrepresents the 3D neighbouring voxels of x, andpˆi−1(c|I(j))represents the probability of voxel j of pertaining to class c computed at the previous iteration.In the maximisation step, the parameters of each class are computed from the voxels’ intensities and their probabilities of belonging to the different classes. The partial volume class parameters are obtained as a proportion of the pure tissue parameters.A common way to compute the mean and covariance matrix is to use the maximum likelihood estimator (MLE) [10,35]:(13)θˆc=argmaxθc∏x=1Nvoxelsp(I(x)|θc).However, the MLE is sensitive to outliers and, as a consequence, one of the parameters can become arbitrarily large. García-Lorenzo et al. [14] proposed using a trimmed likelihood estimator to reduce the effect of those outliers. This new estimator uses the Mahalanobis distance to discard those voxels that could be considered outliers when computing the Gaussian parameters.In our approach, we use an aproximation of such estimator where a probability threshold is used instead of the Mahalanobis distance to compute the class parametersθˆcias follows:(14)μˆci=∑x∈X˜pˆi(c|I(x))I(x)∑x∈X˜pˆi(c|I(x)),(15)Σˆci=∑x∈X˜pˆi(c|I(x))(I(x)−μˆci)t(I(x)−μˆci)∑x∈X˜pˆi(c|I(x)),(16)X˜={x:pˆi(c|I(x))>Tπ},where Tπis the probability threshold used during the initialisation step.Lesions appear hyperintense in FLAIR images. Moreover, GM voxels, the normal appearing tissue with the highest intensity in these images, have a darker distribution than lesion voxels. As a consequence, there is a noticeable difference between normal appearing tissues and lesions in these images. Therefore, lesions that are misclassified by the EM algorithm are actually hyperintense outliers of the GM FLAIR intensity distribution.In order to find a threshold for the FLAIR image, we first assume that GM intensities follow a Gaussian distribution in the FLAIR image (as we did for the other MRI images to segment the tissues). We also assume that lesions are hyperintense outliers of this distribution. With these two assumptions, we can estimate a threshold TFas follows:(17)TF=μGMF+γσGMF,where theμGMFandσGMFare the distribution parameters of GM on the FLAIR image and γ is an empirical parameter used to determine the outliers.To estimate the tissue parameters, the GM mask, obtained in the previous step, is applied to the FLAIR image to compute a histogram (see Fig. 2). Since lesions are usually part of the GM mask (due to their intensity similarities in PD-w and T2-w images), the histogram is biased by the high lesion intensities. This bias does not affect the peak of the histogram, which is used to define the mean, however, it can affect the estimation of the standard deviation. Therefore, we use the full width at half maximum (FWHM) expression to compute it [7].Upon obtainingμGMFandσGMFand using them to compute TFby means of Eq. (17), we apply it to the FLAIR image to obtain an initial lesion mask where other hyperintense artefacts are also included. This mask must be refined, since a large number of false positive lesions are usually found.After thresholding, the mask is relabelled in order to divide it into different regions. A region is defined as a set of voxels that are connected using a 3D neighbourhood cube of connectivity 26. That means that 2 voxels belong to the same region if they are directly connected in a 3D space. We decided to use a region-wise refinement step [1,7,27] to reduce FP in terms of detection due to artefacts.In order to differentiate lesions from other regions, we define a set of rules that are true for white matter lesions (WML):•Lesions are mostly classified as WM and GM-based classes (PV and pure GM). In the case of WM, most lesions share a similar intensity profile to that tissue in T1-w images and have a high probability in the WM map (due to registration limitations); while in the case of GM, lesions share the same intensity profile in T2-w and PD-w images. Furthermore, hypointense lesions share the same intensity profile in T1-w images and present low values in the similarity map (weighting down the atlas probabilities during segmentation). To determine if a region follows this rule, a positive mask (containing WM, PV, and pure GM) and a negative mask (containing the background and all other tissues) are defined and for each region the proportion between positively and negatively masked voxels is computed. If this proportion is higher than the user-defined threshold Tωt, the region is labelled as WML.Lesions are surrounded by WM. We are only focusing on WML, therefore all lesion regions should be surrounded (mostly) by WM voxels. To determine if a region follows this rule, a positive mask (containing only WM) and a negative mask (containing the background and all other tissues) are defined and for each region the proportion between all its positive and negative neighbouring voxels is computed. If this proportion is higher than a user-defined thresholdTωN, the region is labelled as WML.Lesions should not be present between the ventricles. One of the typical MS lesion locations is the surrounding of the ventricles. However, these lesions rarely appear between them and hyperintense regions in these areas are usually due to artefacts. Therefore, we remove all the regions that are close to the centre of the brain (which is usually between the ventricles).Lesions should be of a minimum size. Due to noise and inhomogeneities, some voxels may present random high intensities. These voxels are usually corrected during the preprocessing, however, some of them might still be considered as lesions after thresholding the FLAIR image. To remove these small outliers, we discard all regions that do not conform to a minimum size.Finally, all the regions discarded according to one (or more) of these rules are reclassified according to the tissue segmentation. An example of the final segmentation (including lesions and tissues) is presented in Fig. 3.

@&#CONCLUSIONS@&#
In this paper we have presented an approach that combines the atlas information with the intensity images to, first, produce a tissue segmentation estimate and, then, use this information as part of an outlier thresholding approach to segment lesions. The initial tissue segmentation is conducted as part of a modified EM approach where 4 main classes are identified: CSF, GM, WM, and PV. Once we obtain this initial tissue segmentation using T1-w, T2-w and PD-w images, we apply the GM mask to the FLAIR image, where lesions appear hyperintense in contrast with all the other tissues, to compute its distribution parameters from the histogram. Afterwards, a threshold based on those two parameters is applied to the image to obtain an initial lesion mask. This mask is further refined to reduce false positives by applying a set of rules based on MS lesion properties.We have presented the results for the proposed pipeline with a database of 45 patients from 3 different hospitals with different scanner machines. In general, detection results were fairly higher than segmentation results due to the false positive reduction step, obtaining a good agreement between manual annotations and automatic segmentations. Moreover, we include a comparison with two of the most promising methods of the state-of-the-art. After a thorough numerical analysis, the proposed pipeline presented better detection results and similar segmentation results to those from LST. The improvement over the other two approaches can be explained by our contributions to improve the tissue estimation step by including atlas weighting using a similarity map and neighbourhood information, as well as the introduction of a false positive reduction step based on a regionwise analysis of the automatically segmented lesions.All authors in this paper have no potential conflict of interests.